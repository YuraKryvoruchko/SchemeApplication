<Window x:Class="SchemeApplication.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SchemeApplication"
        xmlns:m="clr-namespace:SchemeApplication.Models"
        xmlns:vm="clr-namespace:SchemeApplication.ViewModels"
        xmlns:vmf="clr-namespace:SchemeApplication.ViewModels.CanvasFigures"
        xmlns:controls="clr-namespace:SchemeApplication.Views.Controls"
        xmlns:conv="clr-namespace:SchemeApplication.Infrastructure.Converters"
        mc:Ignorable="d"
        Title="MainWindow" Height="450" Width="800"
        d:DataContext="{d:DesignInstance vm:MainWindowViewModel}">

    <Window.Resources>
        <conv:BoolToBrushConverter x:Key="BoolToBrushConverter" TrueBrush="#8595ff"/>
    </Window.Resources>

    <Grid Background="#d8dee9" IsHitTestVisible="{Binding IsActiveModification}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition MinWidth="200" MaxWidth="400" Width="auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition MinWidth="200" MaxWidth="400" Width="auto"/>
        </Grid.ColumnDefinitions>
        
        <Border BorderBrush="#545557" BorderThickness="2" Grid.Column="1">
            <ScrollViewer HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible">
                <ScrollViewer.InputBindings>
                    <KeyBinding Key="OemPlus" Modifiers="Ctrl" Command="{Binding ZoomInCommand}"/>  
                    <KeyBinding Key="OemMinus" Modifiers="Ctrl" Command="{Binding ZoomOutCommand}"/>
                    <KeyBinding Key="Delete" Command="{Binding DeleteFigureCommand}"/>
                </ScrollViewer.InputBindings>
                
                <controls:ItemsCanvas x:Name="ItemsCanvas" ItemsSource="{Binding CanvasObjects}">
                    <controls:ItemsCanvas.Resources>
                        <DataTemplate DataType="{x:Type vmf:BlockFigureViewModel}">
                            <Border BorderBrush="{Binding IsSelected, Converter={StaticResource BoolToBrushConverter}}" BorderThickness="4">
                                <Grid Background="#545557" Width="100" Height="65">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="15"/>
                                        <ColumnDefinition/>
                                        <ColumnDefinition Width="15"/>
                                    </Grid.ColumnDefinitions>
                                    <ItemsControl x:Name="InputConnectors" IsEnabled="True" Grid.Column="0" VerticalAlignment="Center" HorizontalAlignment="Center"
                                                  ItemsSource="{Binding Inputs}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Vertical" Background="Transparent" 
                                                           VerticalAlignment="Center"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button CommandParameter="{Binding}"
                                                        Command="{Binding ElementName=ItemsCanvas, Path=DataContext.SetInputConnectorCommand}" 
                                                        Margin="0,10,0,10">
                                                    <Ellipse Width="6" Height="6" Fill="#000000" Loaded="Ellipse_Loaded" IsHitTestVisible="False"/>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <StackPanel Grid.Column="1">
                                        <Image Source="{Binding ImagePath}" Stretch="Fill" Width="auto" Height="53" Margin="1" VerticalAlignment="Top"/>
                                        <TextBlock Width="auto" Height="10" Text="{Binding Name}" FontSize="8" Margin="0" TextAlignment="Center"/>
                                    </StackPanel>

                                    <ItemsControl x:Name="OutputConnectors" Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Center"
                                                  ItemsSource="{Binding Outputs}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Vertical" 
                                                         VerticalAlignment="Center"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button CommandParameter="{Binding}"
                                                        Command="{Binding ElementName=ItemsCanvas, Path=DataContext.SetOutputConnectorCommand}" 
                                                        Margin="0,10,0,10">
                                                    <Ellipse Width="6" Height="6" Fill="#000000" Loaded="Ellipse_Loaded" IsHitTestVisible="False"/>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </Border>
                        </DataTemplate>
                        <DataTemplate DataType="{x:Type vmf:ConnectionFigureViewModel}">
                            <Grid>
                                <Path Stroke="{Binding IsSelected, Converter={StaticResource BoolToBrushConverter}}" StrokeThickness="6">
                                    <Path.Data>
                                        <LineGeometry 
                                            StartPoint="{Binding OutputConnector.Position}"
                                            EndPoint="{Binding InputConnector.Position}"/>
                                    </Path.Data>
                                </Path>
                                <Line Stroke="Black" StrokeThickness="3" 
                                      X1="{Binding OutputConnector.Position.X}" 
                                      Y1="{Binding OutputConnector.Position.Y}" 
                                      X2="{Binding InputConnector.Position.X}" 
                                      Y2="{Binding InputConnector.Position.Y}"/>
                            </Grid>
                        </DataTemplate>
                    </controls:ItemsCanvas.Resources>
                    <controls:ItemsCanvas.ItemContainerStyle>
                        <Style TargetType="controls:DraggableContentControl">
                            <Setter Property="Position" Value="{Binding Position, Mode=TwoWay}"/>
                            <Setter Property="IsDraggable" Value="{Binding IsDraggable}"/>
                            <EventSetter Event="MouseLeftButtonDown" Handler="DraggableContentControl_MouseLeftButtonDown"/>
                        </Style>
                    </controls:ItemsCanvas.ItemContainerStyle>
                    <controls:ItemsCanvas.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas x:Name="Canvas" Background="#ffffff" 
                                    ClipToBounds="True" Width="2500" Height="2500"
                                    HorizontalAlignment="Left" VerticalAlignment="Top"
                                    MouseLeftButtonDown="Canvas_MouseLeftButtonDown">
                                <Canvas.LayoutTransform>
                                    <ScaleTransform ScaleX="{Binding DataContext.Zoom, ElementName=ItemsCanvas}" ScaleY="{Binding DataContext.Zoom, ElementName=ItemsCanvas}"/>
                                </Canvas.LayoutTransform>
                            </Canvas>
                        </ItemsPanelTemplate>
                    </controls:ItemsCanvas.ItemsPanel>
                </controls:ItemsCanvas>
            </ScrollViewer>
        </Border>
        <Border BorderBrush="#545557" BorderThickness="2" Grid.Column="0">
            <TreeView Background="#4b4c4e" HorizontalAlignment="Stretch"
                      ItemsSource="{Binding Path=BlockCategories}"
                      SelectedItemChanged="TreeView_SelectedItemChanged">
                <TreeView.Resources>
                    <HierarchicalDataTemplate DataType="{x:Type m:BlockCategory}"
                                              ItemsSource="{Binding ListBlocks}">
                        <TextBlock Text="{Binding Path=Name}" Foreground="#b1b2b3"></TextBlock>
                    </HierarchicalDataTemplate>
                    <DataTemplate DataType="{x:Type m:ListBlock}">
                        <WrapPanel>
                            <Image Source="{Binding ImagePath}" Width="22"/>
                            <TextBlock Text="{Binding Name}" Margin="5" Foreground="#b1b2b3"/>
                        </WrapPanel>
                    </DataTemplate>
                </TreeView.Resources>
            </TreeView>
        </Border>
        <Border BorderBrush="#545557" BorderThickness="2" Grid.Column="2">
            <StackPanel Background="#4b4c4e" HorizontalAlignment="Stretch">
                <Button VerticalAlignment="Bottom"
                        Margin="10"
                        Content="Simulate"
                        FontSize="20"
                        Command="{Binding Path=StartSimulateCommand}"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
